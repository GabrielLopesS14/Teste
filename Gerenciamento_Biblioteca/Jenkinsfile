pipeline {
    agent any

    stages {
        stage('Install Dependencies') {
            steps {
                echo 'Instalando dependências na raiz do projeto...'
                // CORREÇÃO: Removendo --prefix e dir(), pois o package.json está na raiz do WORKSPACE.
                bat "npm install"
            }
        }

        stage('Lint Code') {
            steps {
                echo 'Executando o linter...'
                // CORREÇÃO: O comando npm run lint é executado na raiz.
                bat "npm run lint"
            }
        }

        stage('Run Tests') {
            steps {
                echo 'Executando os testes...'
                // O erro de caminho do Jest deve ser corrigido aqui,
                // pois o <rootDir> agora é a raiz (C:\...\teste).
                bat "npm test"
            }
        }

        stage('Build Application') {
            steps {
                echo 'Compilando a aplicação...'
                bat "npm run build"
            }
        }

        stage('Start Application') {
            steps {
                echo 'Iniciando o servidor backend...'
                bat "npm start"
            }
        }

        stage('Security Analysis') {
            steps {
                echo 'Executando análise de segurança com npm audit na raiz...'
                bat "npm audit"
            }
        }
    }
}
